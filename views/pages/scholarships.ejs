<% const query = (typeof filters !== 'undefined' && filters) ? filters : (typeof query !== 'undefined' ? query : {}); %>
<!-- Page Header -->
<section class="py-5 bg-light">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto text-center">
        <h1 class="display-5">Scholarship Opportunities</h1>
        <p class="lead text-muted">Discover funding opportunities for your educational journey</p>
      </div>
    </div>
  </div>
</section>

<!-- Search and Filters -->
<section class="py-4 border-bottom">
  <div class="container">
    <form method="GET" action="/scholarships" class="row g-3 align-items-end">
      <!-- Search Query -->
      <div class="col-lg-4">
        <label for="search-query" class="form-label">Search</label>
        <input type="text" class="form-control" id="search-query" name="q" 
               value="<%= query.q || '' %>" 
               placeholder="Keywords, universities, subjects...">
      </div>
      
      <!-- Country Filter -->
      <div class="col-lg-2">
        <label for="country-filter" class="form-label">Country</label>
        <select class="form-select" id="country-filter" name="country">
          <option value="">All Countries</option>
          <% if (typeof countries !== 'undefined' && countries && countries.length > 0) { %>
            <% countries.forEach(country => { %>
              <option value="<%= country.code %>" <%= query.country === country.code ? 'selected' : '' %>>
                <%= country.name %>
              </option>
            <% }) %>
          <% } %>
        </select>
      </div>
      
      <!-- Degree Level Filter -->
      <div class="col-lg-2">
        <label for="degree-filter" class="form-label">Degree Level</label>
        <select class="form-select" id="degree-filter" name="degree">
          <option value="">All Levels</option>
          <option value="Undergraduate" <%= query.degree === 'Undergraduate' ? 'selected' : '' %>>Undergraduate</option>
          <option value="Masters" <%= query.degree === 'Masters' ? 'selected' : '' %>>Masters</option>
          <option value="PhD" <%= query.degree === 'PhD' ? 'selected' : '' %>>PhD</option>
          <option value="Postdoc" <%= query.degree === 'Postdoc' ? 'selected' : '' %>>Postdoc</option>
        </select>
      </div>
      
      <!-- Deadline Filter -->
      <div class="col-lg-2">
        <label for="deadline-filter" class="form-label">Deadline Before</label>
        <input type="date" class="form-control" id="deadline-filter" name="deadlineBefore" 
               value="<%= query.deadlineBefore || '' %>">
      </div>
      
      <!-- Search Button -->
      <div class="col-lg-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
    </form>
    
    <!-- Active Filters -->
    <% if (query.q || query.country || query.degree || query.deadlineBefore) { %>
      <div class="mt-3">
        <span class="text-muted me-2">Active filters:</span>
        <% if (query.q) { %>
          <span class="badge bg-primary me-1">Search: "<%= query.q %>"</span>
        <% } %>
        <% if (query.country) { %>
          <span class="badge bg-success me-1">Country: <%= query.country %></span>
        <% } %>
        <% if (query.degree) { %>
          <span class="badge bg-info me-1">Level: <%= query.degree %></span>
        <% } %>
        <% if (query.deadlineBefore) { %>
          <span class="badge bg-warning me-1">Before: <%= query.deadlineBefore %></span>
        <% } %>
        <a href="/scholarships" class="btn btn-outline-secondary btn-sm ms-2">Clear All</a>
      </div>
    <% } %>
  </div>
</section>

<!-- Results Section -->
<section class="py-5">
  <div class="container">
    <div class="row">
      <!-- Main Content -->
      <div class="col-lg-9">
        <!-- Results Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <% if (scholarships && scholarships.length > 0) { %>
              <h5 class="mb-0">
                <%= totalCount || scholarships.length %> 
                <%= (totalCount === 1) ? 'scholarship' : 'scholarships' %> found
              </h5>
              <% if (query.q) { %>
                <small class="text-muted">for "<%= query.q %>"</small>
              <% } %>
            <% } else { %>
              <h5 class="mb-0">No scholarships found</h5>
            <% } %>
          </div>
          
          <!-- Sort Options -->
          <div>
            <select class="form-select form-select-sm" onchange="updateSort(this.value)">
              <option value="newest" <%= (query.sort === 'newest' || !query.sort) ? 'selected' : '' %>>Newest First</option>
              <option value="deadline" <%= query.sort === 'deadline' ? 'selected' : '' %>>Deadline Soon</option>
              <option value="featured" <%= query.sort === 'featured' ? 'selected' : '' %>>Featured First</option>
            </select>
          </div>
        </div>

        <!-- Scholarship Cards -->
        <div class="row">
          <% if (scholarships && scholarships.length > 0) { %>
            <% scholarships.forEach((scholarship, index) => { %>
              <div class="col-md-6 mb-4">
                <div class="card scholarship-card h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <span class="badge badge-country"><%= scholarship.country_code %></span>
                      <% if (scholarship.featured) { %>
                        <span class="badge badge-featured">Featured</span>
                      <% } %>
                    </div>
                    
                    <h5 class="card-title">
                      <a href="/scholarships/<%= scholarship.slug %>" class="text-decoration-none">
                        <%= scholarship.title %>
                      </a>
                    </h5>
                    
                    <p class="card-text text-muted">
                      <%= scholarship.summary.substring(0, 150) %>
                      <% if (scholarship.summary.length > 150) { %>...<% } %>
                    </p>
                    
                    <!-- Degree Levels -->
                    <div class="mb-3">
                      <% if (scholarship.degree_levels && scholarship.degree_levels.length > 0) { %>
                        <% scholarship.degree_levels.forEach(level => { %>
                          <span class="badge badge-degree me-1"><%= level %></span>
                        <% }) %>
                      <% } %>
                    </div>
                    
                    <!-- Deadline -->
                    <% if (scholarship.deadline) { %>
                      <div class="text-muted mb-3">
                        <i class="fas fa-calendar-alt"></i>
                        <small>
                          Deadline: <%= new Date(scholarship.deadline).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                          <% 
                            const today = new Date();
                            const deadline = new Date(scholarship.deadline);
                            const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                          %>
                          <% if (daysLeft > 0 && daysLeft <= 30) { %>
                            <span class="badge badge-deadline ms-1"><%= daysLeft %> days left</span>
                          <% } else if (daysLeft <= 0) { %>
                            <span class="badge bg-danger ms-1">Expired</span>
                          <% } %>
                        </small>
                      </div>
                    <% } %>
                    
                    <!-- Tags -->
                    <% if (scholarship.tags && scholarship.tags.length > 0) { %>
                      <div class="mb-3">
                        <% scholarship.tags.slice(0, 3).forEach(tag => { %>
                          <span class="badge bg-light text-dark me-1"><%= tag %></span>
                        <% }) %>
                        <% if (scholarship.tags.length > 3) { %>
                          <span class="badge bg-light text-dark">+<%= scholarship.tags.length - 3 %></span>
                        <% } %>
                      </div>
                    <% } %>
                    
                    <div class="mt-auto d-flex gap-2">
                      <a href="/scholarships/<%= scholarship.slug %>" class="btn btn-outline-primary btn-sm flex-grow-1">
                        Learn More
                      </a>
                      <a href="<%= scholarship.official_link %>" class="btn btn-primary btn-sm" target="_blank" rel="noopener">
                        Apply
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Ad insertion every 4 items -->
              <% if ((index + 1) % 4 === 0 && index < scholarships.length - 1) { %>
                <div class="col-12 mb-4">
                  <% if (site.adsenseClient) { %>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="<%= site.adsenseClient %>"
                         data-ad-slot="5555555555"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                  <% } else { %>
                    <div class="ad-placeholder">
                      <small>Advertisement</small>
                    </div>
                  <% } %>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="col-12">
              <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No scholarships found</h4>
                <p class="text-muted">Try adjusting your search criteria or browse all scholarships.</p>
                <a href="/scholarships" class="btn btn-primary">View All Scholarships</a>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (pagination && pagination.totalPages > 1) { %>
          <nav aria-label="Scholarship pagination" class="mt-5">
            <ul class="pagination justify-content-center">
              <% if (pagination.hasPrev) { %>
                <li class="page-item">
                  <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.prevPage}).toString() %>">Previous</a>
                </li>
              <% } %>
              
              <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                  <a class="page-link" href="?<%= new URLSearchParams({...query, page: i}).toString() %>"><%= i %></a>
                </li>
              <% } %>
              
              <% if (pagination.hasNext) { %>
                <li class="page-item">
                  <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.nextPage}).toString() %>">Next</a>
                </li>
              <% } %>
            </ul>
          </nav>
        <% } %>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-3">
        <!-- Quick Stats -->
        <div class="card mb-4">
          <div class="card-body">
            <h6 class="card-title">Quick Stats</h6>
            <ul class="list-unstyled mb-0">
              <li class="d-flex justify-content-between">
                <span>Total Scholarships:</span>
                <strong><%= totalCount || 0 %></strong>
              </li>
              <li class="d-flex justify-content-between">
                <span>Countries:</span>
                <strong><%= (typeof countries !== 'undefined' && countries && countries.length) || 0 %></strong>
              </li>
              <li class="d-flex justify-content-between">
                <span>Featured:</span>
                <strong><%= featuredCount || 0 %></strong>
              </li>
            </ul>
          </div>
        </div>

        <!-- Recommended Resources -->
        <div class="card mb-4">
          <div class="card-body">
            <h6 class="card-title">Recommended Resources</h6>
            <div class="list-group list-group-flush">
              <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                <small>📚 IELTS Preparation Guide</small>
              </a>
              <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                <small>✏️ Essay Writing Masterclass</small>
              </a>
              <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                <small>🎓 University Application Tips</small>
              </a>
              <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                <small>💼 Interview Preparation</small>
              </a>
            </div>
          </div>
        </div>

        <!-- Sidebar Ad -->
        <% if (site.adsenseClient) { %>
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="<%= site.adsenseClient %>"
               data-ad-slot="9999999999"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
          <script>
               (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        <% } else { %>
          <div class="ad-placeholder">
            <small>Advertisement</small>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</section>

<script>
function updateSort(sortValue) {
  const url = new URL(window.location);
  if (sortValue === 'newest') {
    url.searchParams.delete('sort');
  } else {
    url.searchParams.set('sort', sortValue);
  }
  window.location.href = url.toString();
}
</script>